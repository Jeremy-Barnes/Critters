<div class="container-fluid">
    <div class="page-title">
        <h1>Mail</h1>
    </div>
</div>
<div class="container-fluid container-maxWidth">
        <!----------------------CONVERSATION VIEW------------------>
        <div id="viewDetail" *ngIf="activeConversation!=null">
            <div class="conversationTitle"><button (click)="returnToOverview()" class="btn btn-default"> <i class="fa fa-long-arrow-left" aria-hidden="true"></i>  </button> <h2>{{activeConversation[0].messageSubject}}</h2> <hr /></div>
            <div *ngFor="let message of activeConversation">
                <div class="subjectBar">
                    <span><img class="userThumb" src="{{user.userImagePath}}" /> <a class="messageUser">{{message.sender.userName}}</a></span>
                    <span class="messageDate">{{message.dateSent.toLocaleString()}} 
                    <button class="btn btn-default" (click)="toggleHideMessage(message)">
                        <i class="fa fa-minus" *ngIf="!message.collapsed" aria-hidden="true"></i>
                        <i class="fa fa-plus" *ngIf="message.collapsed" aria-hidden="true"></i> 
                    </button>
                    </span>
                    <div class="messageSubject">{{message.messageSubject}}</div>
                </div>
                <div class="messageGuts" *ngIf="!message.collapsed">
                    <br />
                    <p>{{message.messageText}}</p>

                    <button class="btn btn-primary" (click)="reply(message)"><i class="fa fa-reply" aria-hidden="true"></i> Reply  </button>
                    <button class="btn btn-default" (click)="deleteConversation(message)" ><i class="fa fa-trash-o" aria-hidden="true"></i> delete</button>

                    <div id="reply" *ngIf="replyMessage != null && newMessage!=null && replyMessage.messageID == message.messageID">
                        <input type="text" [(ngModel)]="newMessage.messageSubject" placeholder="subject" /> <br />
                        <textarea [(ngModel)]="newMessage.messageText" placeholder="Reply text goes here"></textarea><br />
                        <button (click)="sendMessage()" class="btn btn-success"><i class="fa fa-arrow-right" aria-hidden="true"></i> Send </button>
                        <button (click)="cancelReply()" class="btn btn-default"><i class="fa fa-times" aria-hidden="true"></i> cancel </button>
                    </div>
                </div>
                <hr />

                <!--<input type="button" (click)="replyLatest()" value="Reply Latest" />
                <input type="button" (click)="deleteConversation(activeConversation)" value="Delete Conversation" />-->
            </div>
        </div>


        <!----------------------COMPOSE VIEW------------------>
        <div id="composeNew" *ngIf="activeConversation==null && newMessage!=null">
            To: <autocomplete *ngIf="composeToFriend == null"
                              [autocomplete-local-func]="searchFriends" [autocomplete-remote-func]="searchUsers" (result-out)="onItemSelected($event)"></autocomplete>
            <span *ngIf="composeToFriend != null">{{composeToFriend.userName}} <a (click)="deselctComposeFriend()">X</a></span>
            <br />
            Subject: <input type="text" [(ngModel)]="newMessage.messageSubject" /> <br />

            Message: <textarea [(ngModel)]="newMessage.messageText"></textarea><br />
            <input type="button" (click)="sendMessage()" value="Send" />
            <input type="button" (click)="cancelCompose()" value="Stop Editing" />
        </div>


        <!----------------------MAIN VIEW------------------>
        <div id="mainView" *ngIf="activeConversation==null && newMessage == null">
            <ul class="nav nav-tabs">
                <li role="presentation" class="active"><a data-toggle="tab" href="#inbox">Inbox</a></li>
                <li role="presentation"><a data-toggle="tab" href="#sent">Sent</a></li>
                <li role="presentation"><a data-toggle="tab" href="#friends">Friends</a></li>
            </ul>
            <div class="tab-content">

                <div id="inbox" class="tab-pane fade in active">
                    <div class="buttons">
                        <button class="btn btn-primary" (click)="composeNewMessage()"><i class="fa fa-plus"></i> New Message</button>
                        <button class="btn btn-default" (click)="selectAll()"><i class="fa fa-check-circle"></i> select all</button>
                        <div class="conditionalButtons inlineblock">
                            <button class="btn btn-default" (click)="affectSelectedInbox(true)" [ngClass]="{'hide' : selectedConversations.length == 0 }"><i class="fa fa-trash-o"></i> delete</button>
                            <button class="btn btn-default" (click)="affectSelectedInbox(false)" [ngClass]="{'hide' : selectedConversations.length == 0 }"><i class="fa fa-envelope-open-o"></i> mark as unread</button>
                        </div>
                    </div>

                    <table class="table">
                        <tr class="messagePreview" [ngClass]="{'read' : !isUnread(conversation), 'selectedMessage' : conversation.selected }" *ngFor="let conversation of messages; let i = index">
                            <td> 
                                <div class="circlecheckbox" (click)="selectConversation($event, conversation)">
                                    <input type="checkbox" value="1" [attr.id]="'inboxCheckbox' + i" [(ngModel)]="conversation.selected" name="" /> 
                                    <label [attr.for]="'inboxCheckbox' + i" >
                                        <i class="fa fa-check-circle"></i>
                                    </label >
                                </div>
                            </td>
                            <td (click)="viewDetail(conversation)" class="inlineblock messageUserThumb">
                                <span>
                                    <a [routerLink]="['/viewUser/', conversation.messages[0].sender.userID]">
                                        <img  src="{{user.userImagePath}}" class="userThumb" />
                                    </a>
                                </span>
                            </td>
                            <td (click)="viewDetail(conversation)" class="inlineblock messageUser">
                                <span>
                                    <a [routerLink]="['/viewUser/', conversation.messages[0].sender.userID]" class="messageUser">
                                        {{conversation.messages[0].sender.userName}}
                                    </a>
                                </span>
                            </td>
                            <td class="inlineblock" (click)="viewDetail(conversation)">
                                <div class="messageSubject inlineblock">
                                    {{conversation.messages[0].messageSubject | limitTo:50}}
                                    <div *ngIf="conversation.messages[0].messageSubject == null || conversation.messages[0].messageSubject.length == 0"> [No Subject] </div> —
                                </div>
                                <div class="messageText inlineblock">{{conversation.messages[conversation.messages.length -1].messageText | limitTo:120 }}</div>
                            </td>
                            <td class="inlineblock messageDate" (click)="viewDetail(conversation)">
                                {{conversation.messages[conversation.messages.length -1].dateSent | date:'short'}}
                            </td>
                        </tr>
                    </table>

                    <div class="buttons">
                        <button class="btn btn-primary" (click)="composeNewMessage()"><i class="fa fa-plus"></i> New Message</button>
                        <button class="btn btn-default" (click)="selectAll()"><i class="fa fa-check-circle"></i> select all</button>
                        <div class="conditionalButtons inlineblock">
                            <button class="btn btn-default" (click)="affectSelectedInbox(true)" [ngClass]="{'hide' : selectedConversations.length == 0 }"><i class="fa fa-trash-o"></i> delete</button>
                            <button class="btn btn-default" (click)="affectSelectedInbox(false)" [ngClass]="{'hide' : selectedConversations.length == 0 }"><i class="fa fa-envelope-open-o"></i> mark as unread</button>
                        </div>
                    </div>
                </div>

                <div id="sent" class="tab-pane fade in">
                    <div class="buttons">
                        <button class="btn btn-primary" (click)="composeNewMessage()"><i class="fa fa-plus"></i> New Message</button>
                        <button class="btn btn-default" (click)="selectAll()"><i class="fa fa-check-circle"></i> select all</button>
                        <div class="conditionalButtons inlineblock">
                            <button class="btn btn-default" (click)="affectSelectedSentbox(true)" [ngClass]="{'hide' : selectedMessages.length == 0 }"><i class="fa fa-trash-o"></i> delete</button>
                        </div>
                    </div>

                    <table class="table">
                        <tr class="messagePreview" *ngFor="let message of sentMessages; let i = index">
                            <td>
                                <div class="circlecheckbox" (click)="selectMessage($event, message)">
                                    <input type="checkbox" value="1" [(ngModel)]="message.selected" [attr.id]="'sentCheckbox' + i" name="" />
                                    <label [attr.for]="'sentCheckbox' + i">
                                        <i class="fa fa-check-circle fa-2"></i>
                                    </label>
                                </div>
                            </td>
                            <td (click)="viewSentDetail(message)" class="inlineblock messageUser">
                                <span>
                                    <a [routerLink]="['/viewUser/', message.recipient.userID]" class="messageUser">
                                        To: {{message.recipient.userName}}
                                    </a>
                                </span>
                            </td>
                            <td (click)="viewSentDetail(message)" class="inlineblock">
                                <div class="messageSubject inlineblock">
                                    {{message.messageSubject | limitTo:50}}
                                    <div *ngIf="message.messageSubject == null || message.messageSubject.length == 0"> [No Subject] </div> —
                                </div>
                                {{message.messageText | limitTo:120 }}
                            </td>
                            <td (click)="viewSentDetail(message)" class="inlineblock">
                                {{message.dateSent | date:'short'}}
                            </td>
                        </tr>
                    </table>

                    <div class="buttons">
                        <button class="btn btn-primary" (click)="composeNewMessage()"><i class="fa fa-plus"></i> New Message</button>
                        <button class="btn btn-default" (click)="selectAll()"><i class="fa fa-check-circle"></i> select all</button>
                        <div class="conditionalButtons inlineblock">
                            <button class="btn btn-default" (click)="affectSelectedSentbox(true)" [ngClass]="{'hide' : selectedMessages.length == 0 }"><i class="fa fa-trash-o"></i> delete</button>
                        </div>
                    </div>
                </div>



                <div id="friends" class="tab-pane fade">
                    These people want to be your friends!
                    <div *ngFor="let friend of pendingFriendRequests">
                        <div class="messageSubject">
                            <a [routerLink]="['/viewUser/', friend.requester.userID]"
                               class="messageUser">{{friend.requester.userName}}</a> | {{friend.requester.firstName}} {{friend.requester.lastName}}
                        </div>
                        <div><span>Sent on: {{friend.dateSent}}</span></div>
                        <input type="button" (click)="acceptRequest(friend)" value="Accept Friend Request" />
                        <input type="button" (click)="declineRequest(friend)" value="Decline Friend Request" />
                        <br />
                    </div>
                    <br /><br />
                    Your outstanding friend requests
                    <div *ngFor="let friend of outstandingFriendRequests">
                        <div class="messageSubject">
                            <a class="messageUser" [routerLink]="['/viewUser/', friend.requested.userID]">
                                {{friend.requested.userName}}
                            </a> | {{friend.requested.firstName}} {{friend.requested.lastName}}
                        </div>
                        <div><span>Sent on: {{friend.dateSent}}</span></div>
                        <input type="button" (click)="cancelRequest(friend)" value="Cancel Friend Request" />
                        <br />
                    </div>
                </div>
            </div>
        </div>
</div>    