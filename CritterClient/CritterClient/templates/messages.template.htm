<div class="container-fluid">
    <div class="page-title">
        <h1>Mail</h1>
    </div>
</div>
<div class="container-fluid container-maxWidth pageContent">
        <!----------------------MAIN VIEW------------------>
    <div id="messagesMainView">
        <ul id="messageTabs" class="nav nav-tabs">
            <li role="presentation"><a class="active" (click)="returnToOverview(0)" data-toggle="tab" href="#inbox">Inbox</a></li>
            <li role="presentation"><a (click)="returnToOverview(1)" data-toggle="tab" href="#sent">Sent</a></li>
            <li role="presentation"><a (click)="returnToOverview(2)" data-toggle="tab" href="#friends">Buddies</a></li>
        </ul>

        <!----------------------COMPOSE VIEW------------------>
        <div id="composeNew" class="row" *ngIf="activeConversation==null && newMessage!=null">
            <div id="compose" class="messageGuts col-md-8">
                <autocomplete [placeholder]="'To...'" *ngIf="composeToFriend == null"
                                [autocomplete-local-func]="searchFriends" [autocomplete-remote-func]="searchUsers" (result-out)="onItemSelected($event)">
                </autocomplete>
                <span *ngIf="composeToFriend != null">{{composeToFriend.userName}} <a (click)="deselctComposeFriend()"><i class="fa fa-times"></i></a></span>
                <input class="form-control" type="text" [(ngModel)]="newMessage.messageSubject" placeholder="subject" />
                <textarea class="form-control" rows="6" [(ngModel)]="newMessage.messageText" placeholder="Message text goes here"></textarea>
                <button (click)="sendMessage()" class="btn btn-success"><i class="fa fa-arrow-right" aria-hidden="true"></i> Send </button>
                <button (click)="cancelCompose()" class="btn btn-default"><i class="fa fa-times" aria-hidden="true"></i> cancel </button>
            </div>
        </div>

        <!----------------------CONVERSATION VIEW------------------>
        <div id="viewDetail" *ngIf="activeConversation!=null">
            <div class="conversationTitle">
                <div>
                    <button (click)="returnToOverview()" class="btn btn-default icon-btn">
                        <i class="fa fa-long-arrow-alt-left" aria-hidden="true"></i>
                    </button>
                </div>
                <div class="full-width">
                    <h2>
                        {{activeConversation[0].messageSubject}}
                        <span class="inlineblock" *ngIf="activeConversation[0].messageSubject == null || activeConversation[0].messageSubject.length == 0"> [No Subject] </span>
                    </h2>
                </div>
            </div>
            <div *ngFor="let message of activeConversation">
                <div class="subjectBar clearfix">
                    <div class="pull-left">
                        <img class="userThumb" src="{{message.sender.userImagePath}}" /> <a class="messageUser">{{message.sender.userName}}</a>
                    </div>
                    <div class="messageToggle pull-right">
                        <button class="btn btn-default icon-btn" (click)="toggleHideMessage(message)">
                            <i class="fa fa-minus" *ngIf="!message.collapsed" aria-hidden="true"></i>
                            <i class="fa fa-plus" *ngIf="message.collapsed" aria-hidden="true"></i>
                        </button>
                    </div>
                    <div class="messageDate pull-right">
                        {{message.dateSent.toLocaleString()}}
                    </div>
                </div>
                <div class="row">
                    <div class="messageGuts col-lg-8" *ngIf="!message.collapsed">
                        <p>{{message.messageText}}</p>

                        <button class="btn btn-primary" (click)="reply(message)"><i class="fa fa-reply" aria-hidden="true"></i> Reply  </button>
                        <button class="btn btn-default" (click)="deleteConversation(message)"><i class="far fa-trash-alt" aria-hidden="true"></i> delete</button>

                        <div id="reply" *ngIf="replyMessage != null && newMessage!=null && replyMessage.messageID == message.messageID">
                            <textarea class="form-control" rows="6" [(ngModel)]="newMessage.messageText" placeholder="Reply text goes here"></textarea>
                            <button (click)="sendMessage()" class="btn btn-success"><i class="fa fa-arrow-right" aria-hidden="true"></i> Send </button>
                            <button (click)="cancelReply()" class="btn btn-default"><i class="fa fa-times" aria-hidden="true"></i> cancel </button>
                        </div>
                    </div>
                </div>
                <hr />
            </div>
        </div>

        <!----------------------INBOX------------------>

        <div class="tab-content"  *ngIf="activeConversation==null && newMessage == null">
            <div id="inbox"  [ngClass]="{'active' : !loadingTabs || (loadingTabs && tab==0)}" class="tab-pane fade in active">
                <div class="buttons">
                    <button class="btn btn-primary" (click)="composeNewMessage()"><i class="fa fa-plus"></i> New Message</button>
                    <button class="btn btn-default" (click)="selectAll()"><i class="fa fa-check-circle"></i> select all</button>
                    <div class="conditionalButtons inlineblock">
                        <button class="btn btn-default" (click)="affectSelectedInbox(true)" [ngClass]="{'hide' : selectedConversations.length == 0 }"><i class="far fa-trash-alt"></i> delete</button>
                        <button class="btn btn-default" (click)="affectSelectedInbox(false)" [ngClass]="{'hide' : selectedConversations.length == 0 }"><i class="far fa-envelope-open"></i> mark as unread</button>
                    </div>
                </div>

                <div class="messagePreviewWrapper">
                    <div class="messagePreview" [ngClass]="{'read' : !isUnread(conversation), 'selectedMessage' : conversation.selected }" *ngFor="let conversation of messages; let i = index">
                        <div class="messageCheckBox">
                            <div class="circlecheckbox" (click)="selectConversation($event, conversation)">
                                <input type="checkbox" value="1" [attr.id]="'inboxCheckbox' + i" [(ngModel)]="conversation.selected" name="" />
                                <label [attr.for]="'inboxCheckbox' + i">
                                    <i class="fa fa-check-circle"></i>
                                </label>
                            </div>
                        </div>
                        <div (click)="viewDetail(conversation)" class="messageUserThumb">
                            <span *ngIf="conversation.messages[0].sender.userID == user.userID && conversation.messages[0].recipient.userID != conversation.messages[0].sender.userID">
                                <a [routerLink]="['/viewUser/', conversation.messages[0].recipient.userID]">
                                    <img src="{{conversation.messages[0].recipient.userImagePath}}" class="userThumb" />
                                </a>
                            </span>
                            <span *ngIf="conversation.messages[0].recipient.userID == user.userID">
                                <a [routerLink]="['/viewUser/', conversation.messages[0].sender.userID]">
                                    <img src="{{conversation.messages[0].sender.userImagePath}}" class="userThumb" />
                                </a>
                            </span>
                        </div>
                        <div (click)="viewDetail(conversation)" class="messageUser">
                            <span *ngIf="conversation.messages[0].sender.userID == user.userID && conversation.messages[0].sender.userID != conversation.messages[0].recipient.userID">
                                <a [routerLink]="['/viewUser/', conversation.messages[0].recipient.userID]" class="messageUser">
                                    {{conversation.messages[0].recipient.userName}}
                                </a>
                            </span>
                            <span *ngIf="conversation.messages[0].recipient.userID == user.userID">
                                <a [routerLink]="['/viewUser/', conversation.messages[0].sender.userID]" class="messageUser">
                                    {{conversation.messages[0].sender.userName}}
                                </a>
                            </span>
                        </div>
                        <div class="messageContent" (click)="viewDetail(conversation)">
                            <div class="messageSubject">
                                <div class="overflow-ellipsis">
                                    {{conversation.messages[0].messageSubject | limitTo:50}}</div>
                                    <div class="inlineblock" *ngIf="conversation.messages[0].messageSubject == null || conversation.messages[0].messageSubject.length == 0"> [No Subject] </div><span class="hidden-xs hidden-sm"> — </span>
                            </div>
                            <div class="messageText">
                            <div class="overflow-ellipsis">{{conversation.messages[conversation.messages.length -1].messageText | limitTo:100 }}</div></div>
                        </div>
                        <div class="messageDate" (click)="viewDetail(conversation)">
                            {{conversation.messages[conversation.messages.length -1].dateSent | date:'short'}}
                        </div>
                    </div>
                </div>

                <div class="buttons">
                    <button class="btn btn-primary" (click)="composeNewMessage()"><i class="fa fa-plus"></i> New Message</button>
                    <button class="btn btn-default" (click)="selectAll()"><i class="fa fa-check-circle"></i> select all</button>
                    <div class="conditionalButtons inlineblock">
                        <button class="btn btn-default" (click)="affectSelectedInbox(true)" [ngClass]="{'hide' : selectedConversations.length == 0 }"><i class="far fa-trash-alt"></i> delete</button>
                        <button class="btn btn-default" (click)="affectSelectedInbox(false)" [ngClass]="{'hide' : selectedConversations.length == 0 }"><i class="far fa-envelope-open"></i> mark as unread</button>
                    </div>
                </div>
            </div>

            <!----------------------SENT------------------>

            <div id="sent" [ngClass]="{'active' : (loadingTabs && tab==1)}" class="tab-pane fade in">
                <div class="buttons">
                    <button class="btn btn-primary" (click)="composeNewMessage()"><i class="fa fa-plus"></i> New Message</button>
                    <button class="btn btn-default" (click)="selectAll()"><i class="fa fa-check-circle"></i> select all</button>
                    <div class="conditionalButtons inlineblock">
                        <button class="btn btn-default" (click)="affectSelectedSentbox(true)" [ngClass]="{'hide' : selectedMessages.length == 0 }"><i class="far fa-trash-alt"></i> delete</button>
                    </div>
                </div>

                <div class="messagePreviewWrapper">
                    <div class="messagePreview" [ngClass]="{'selectedMessage' : message.selected }" *ngFor="let message of sentMessages; let i = index">
                        <div class="messageCheckBox">
                            <div class="circlecheckbox" (click)="selectMessage($event, message)">
                                <input type="checkbox" value="1" [(ngModel)]="message.selected" [attr.id]="'sentCheckbox' + i" name="" />
                                <label [attr.for]="'sentCheckbox' + i">
                                    <i class="fa fa-check-circle fa-2"></i>
                                </label>
                            </div>
                        </div>
                        <div (click)="viewDetail(conversation)" class="messageUserThumb">
                            <a [routerLink]="['/viewUser/', message.recipient.userID]">
                                <img src="{{message.recipient.userImagePath}}" class="userThumb" />
                            </a>
                        </div>
                        <div (click)="viewSentDetail(message)" class="messageUser">
                            <span>
                                <a [routerLink]="['/viewUser/', message.recipient.userID]" class="messageUser">
                                    To:&nbsp;{{message.recipient.userName}}
                                </a>
                            </span>
                        </div>
                        <div class="messageContent" (click)="viewSentDetail(message)">
                            <div class="messageSubject">
                                <div class="overflow-ellipsis">
                                    {{message.messageSubject | limitTo:50}}
                                    <div class="inlineblock" *ngIf="message.messageSubject == null || message.messageSubject.length == 0"> [No Subject] </div>
                                    <span class="hidden-xs hidden-sm"> — </span>
                                </div>
                            </div>
                            <div class="messageText">
                                <div class="overflow-ellipsis">{{message.messageText | limitTo:100 }}</div>
                            </div>
                        </div>
                        <div (click)="viewSentDetail(message)" class="messageDate">
                            {{message.dateSent | date:'short'}}
                        </div>
                    </div>
                </div>

                <div class="buttons">
                    <button class="btn btn-primary" (click)="composeNewMessage()"><i class="fa fa-plus"></i> New Message</button>
                    <button class="btn btn-default" (click)="selectAll()"><i class="fa fa-check-circle"></i> select all</button>
                    <div class="conditionalButtons inlineblock">
                        <button class="btn btn-default" (click)="affectSelectedSentbox(true)" [ngClass]="{'hide' : selectedMessages.length == 0 }"><i class="far fa-trash-alt"></i> delete</button>
                    </div>
                </div>
            </div>

            <!----------------------BUDDIES------------------>

            <div [ngClass]="{'active' : (loadingTabs && tab==2)}" id="friends" class="tab-pane fade in">
                <div class="row">
                    <div id="friendRequests" class="col-md-6 col-md-push-6 col-sm-12">
                        <h2>Buddy Requests</h2>
                        <div class="messagePreviewWrapper">
                            <div class="messagePreview" [ngClass]="{'selectedMessage' : friend.selected }" *ngFor="let friend of pendingFriendRequests; let i = index">
                                <div class="messageCheckBox">
                                    <div class="circlecheckbox" (click)="selectFriendship($event, friend)">
                                        <input type="checkbox" value="1" [attr.id]="'pendfriendCheckbox' + i" [(ngModel)]="friend.selected" name="" />
                                        <label [attr.for]="'pendfriendCheckbox' + i">
                                            <i class="fa fa-check-circle"></i>
                                        </label>
                                    </div>
                                </div>
                                <div class="messageUserThumb">
                                    <span>
                                        <a [routerLink]="['/viewUser/', friend.requested.userID]">
                                            <img src="{{friend.requester.userImagePath}}" class="userThumb" />
                                        </a>
                                    </span>
                                </div>
                                <div class="messageUser full-width">
                                    <span>
                                        <a [routerLink]="['/viewUser/', friend.requester.userID]" class="messageUser">
                                            {{friend.requester.userName}}
                                        </a>
                                    </span>
                                </div>
                                <div class="messageDate">
                                    {{friend.dateSent | date:'MMMd' }}
                                </div>
                                <div class="messageAction">
                                    <button class="btn btn-success icon-btn" (click)="acceptRequest(friend)"><i class="fa fa-check"></i></button>
                                    <button class="btn btn-danger icon-btn" (click)="declineRequest(friend)"><i class="fa fa-times"></i></button>
                                </div>
                            </div>
                        </div>
                        <h2>Sent Requests</h2>
                        <div class="messagePreviewWrapper">
                            <div class="messagePreview" [ngClass]="{'selectedMessage' : friend.selected }" *ngFor="let friend of outstandingFriendRequests; let i = index">
                                <div class="messageCheckBox">
                                    <div class="circlecheckbox" (click)="selectFriendship($event, friend)">
                                        <input type="checkbox" value="1" [attr.id]="'outfriendCheckbox' + i" [(ngModel)]="friend.selected" name="" />
                                        <label [attr.for]="'outfriendCheckbox' + i">
                                            <i class="fa fa-check-circle"></i>
                                        </label>
                                    </div>
                                </div>
                                <div class="messageUserThumb">
                                    <span>
                                        <a [routerLink]="['/viewUser/', friend.requested.userID]">
                                            <img src="{{friend.requested.userImagePath}}" class="userThumb" />
                                        </a>
                                    </span>
                                </div>
                                <div class="messageUser full-width">
                                    <span>
                                        <a [routerLink]="['/viewUser/', friend.requester.userID]" class="messageUser">
                                            {{friend.requested.userName}}
                                        </a>
                                    </span>
                                </div>
                                <div class="messageDate">
                                    {{friend.dateSent | date:'MMMd' }}
                                </div>
                                <div class="messageAction">
                                    <button class="btn btn-default" (click)="cancelRequest(friend)">Cancel</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="currentFriends" class="col-md-6  col-md-pull-6 col-sm-12">
                        <h2>Current Buddies</h2>
                        <div class="messagePreviewWrapper">
                            <div class="messagePreview" [ngClass]="{'selectedMessage' : friend.selected }" *ngFor="let friend of friends; let i = index">
                                <div class="messageCheckBox">
                                    <div class="circlecheckbox" (click)="selectFriendship($event, friend)">
                                        <input type="checkbox" value="1" [attr.id]="'friendCheckbox' + i" [(ngModel)]="friend.selected" name="" />
                                        <label [attr.for]="'friendCheckbox' + i">
                                            <i class="fa fa-check-circle"></i>
                                        </label>
                                    </div>
                                </div>
                                <div class="messageUserThumb">
                                    <span *ngIf="friend.requester.userID != user.userID">
                                        <a [routerLink]="['/viewUser/', friend.requester.userID]">
                                            <img src="{{friend.requester.userImagePath}}" class="userThumb" />
                                        </a>
                                    </span>
                                    <span *ngIf="friend.requested.userID != user.userID">
                                        <a [routerLink]="['/viewUser/', friend.requested.userID]">
                                            <img src="{{friend.requested.userImagePath}}" class="userThumb" />
                                        </a>
                                    </span>
                                </div>
                                <div class="messageUser full-width">
                                    <span *ngIf="friend.requester.userID != user.userID">
                                        <a [routerLink]="['/viewUser/', friend.requester.userID]" class="messageUser">
                                            {{friend.requester.userName}}
                                        </a>
                                    </span>
                                    <span *ngIf="friend.requested.userID != user.userID">
                                        <a [routerLink]="['/viewUser/', friend.requested.userID]" class="messageUser">
                                            {{friend.requested.userName}}
                                        </a>
                                    </span>
                                </div>
                                <div class="messageAction">
                                    <img (click)="writeMessage(friend)" src="../img/closed-envelope-grey.png" />
                                </div>
                            </div>
                        </div>
                    </div>
                    
                </div>
            </div>
        </div>
    </div>
</div>    